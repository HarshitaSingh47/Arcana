(function () {
    'use strict';

    function configureRoutes($routeProvider) {
        $routeProvider.when('/', {
            templateUrl: '/app/home/home.html',
            controller: 'home',
            controllerAs: 'vm'
        });

        $routeProvider.when('/login', {
            templateUrl: '/app/auth/login.html',
            controller: 'login',
            controllerAs: 'vm'
        });

        $routeProvider.when('/register', {
            templateUrl: '/app/auth/register.html',
            controller: 'register',
            controllerAs: 'vm'
        });

        $routeProvider.when('/profile', {
            templateUrl: '/app/auth/profile.html',
            controller: 'profile',
            controllerAs: 'vm'
        });

        $routeProvider.when('/cards', {
            templateUrl: '/app/cards/cards.html',
            controller: 'cards',
            controllerAs: 'vm'
        });

        $routeProvider.when('/decks', {
            templateUrl: '/app/decks/decks.html',
            controller: 'decks',
            controllerAs: 'vm'
        });

        $routeProvider.when('/deckbuilder', {
            templateUrl: '/app/deckbuilder/deckbuilder.html',
            controller: 'deckbuilder',
            controllerAs: 'vm'
        });

        $routeProvider.when('/store', {
            templateUrl: '/app/store/store.html',
            controller: 'store',
            controllerAs: 'vm'
        });

        $routeProvider.when('/lobby', {
            templateUrl: '/app/lobby/lobby.html',
            controller: 'lobby',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/rooms', {
            templateUrl: '/app/admin/rooms/adminRooms.html',
            controller: 'adminRooms',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/rooms/add', {
            templateUrl: '/app/admin/rooms/adminAddRoom.html',
            controller: 'adminAddRoom',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/cards', {
            templateUrl: '/app/admin/cards/adminCards.html',
            controller: 'adminCards',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/cards/add', {
            templateUrl: '/app/admin/cards/adminAddCard.html',
            controller: 'adminAddCard',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/cards/edit/:cardId', {
            templateUrl: '/app/admin/cards/adminEditCard.html',
            controller: 'adminEditCard',
            controllerAs: 'vm',
            resolve: {
                cardId: ['$route', function ($route) {
                    return $route.current.params.cardId;
                }]
            }
        });

        $routeProvider.when('/admin/cards/copy/:cardId', {
            templateUrl: '/app/admin/cards/adminCopyCard.html',
            controller: 'adminCopyCard',
            controllerAs: 'vm',
            resolve: {
                cardId: ['$route', function ($route) {
                    return $route.current.params.cardId;
                }]
            }
        });

        $routeProvider.when('/admin/decks', {
            templateUrl: '/app/admin/decks/adminDecks.html',
            controller: 'adminDecks',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/decks/add', {
            templateUrl: '/app/admin/decks/adminAddDeck.html',
            controller: 'adminAddDeck',
            controllerAs: 'vm'
        });

        $routeProvider.when('/admin/decks/edit/:deckId', {
            templateUrl: '/app/admin/decks/adminEditDeck.html',
            controller: 'adminEditDeck',
            controllerAs: 'vm',
            resolve: {
                deckId: ['$route', function ($route) {
                    return $route.current.params.deckId;
                }]
            }
        });
    }
    configureRoutes.$inject = ['$routeProvider'];

    function onAppRun($rootScope, $location) {
        /*jslint unparam: true*/
        $rootScope.$on('$routeChangeError', function (event, next, previous, error) {
            if (error === 'AUTH_REQUIRED') {
                var redirPath = next.$$route.originalPath;
                $location.path('/login').search('redirect', redirPath);
            }
        });
        /*jslint unparam: false*/
    }
    onAppRun.$inject = ['$rootScope', '$location'];

    angular.module('arcana', ['ngRoute', 'ngAnimate', 'firebase', 'ui.bootstrap'])
        .constant('FIREBASE_URL', 'https://glaring-heat-7532.firebaseio.com/')
        .constant('CARD_TYPES', ['$id', 'cardName', 'cardType', 'label', 'genValue', 'instanceCost', 'maintenanceCost', 'burnValue', 'health', 'power', 'rarity', 'description', 'flavorText', 'creatureType'])
        .config(configureRoutes)
        .run(onAppRun);
}());
(function () {
    'use strict';

    function cards($location, $firebaseObject, $firebaseAuth, FIREBASE_URL, currentAuth) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL);

        vm.currentUser = undefined;

        function activate() {
            if (currentAuth && currentAuth.uid) {
                $firebaseObject(fbRef.child('users').child(currentAuth.uid)).$loaded().then(function (user) {
                    vm.currentUser = {
                        uid: user.uid,
                        username: user.username
                    };
                });
            } else {
                $location.path('/login').search('redirect', 'cards');
            }
        }

        $firebaseAuth(fbRef).$onAuth(function (auth) {
            if (!auth) {
                $location.path('/login').search('redirect', 'cards');
            }
        });

        activate();
    }
    cards.$inject = ['$location', '$firebaseObject', '$firebaseAuth', 'FIREBASE_URL', 'currentAuth'];

    angular.module('arcana').controller('cards', cards);
}());
(function () {
    'use strict';

    function login($location, authService) {
        var vm = this;

        vm.emailAddress = '';
        vm.password = '';
        vm.errorMessage = '';

        vm.login = function () {
            var urlParams = $location.search(),
                redirect = urlParams.redirect || '/',
                model = {
                    email: vm.emailAddress,
                    password: vm.password
                };

            authService.login(model).then(function (authData) {
                if (authData) {
                    $location.search('redirect', null);
                    $location.path(redirect);
                }
            }).catch(function (error) {
                vm.errorMessage = 'Username or password invalid';
            });
        };
    }
    login.$inject = ['$location', 'authService'];

    angular.module('arcana').controller('login', login);
}());
(function () {
    'use strict';

    function register($location, authService) {
        var vm = this;

        vm.emailAddress = '';
        vm.username = '';
        vm.password = '';
        vm.errorMessage = '';

        vm.register = function () {
            var model = {
                email: vm.emailAddress,
                password: vm.password,
                username: vm.username
            };

            // Returns an ASQ object so we can catch any failures
            authService.register(model).then(function () {
                $location.path('/');
            }).or(function (error) {
                if (error.code === 'EMAIL_TAKEN') {
                    vm.errorMessage = 'That email is already in use. Please choose another.';
                } else if (error.code === 'USERNAME_TAKEN') {
                    vm.errorMessage = 'That username is already in use. Please choose another.';
                }
            });
        };
    }
    register.$inject = ['$location', 'authService'];

    angular.module('arcana').controller('register', register);
}());
(function () {
    'use strict';

    function deckbuilder($location, $firebaseObject, $firebaseAuth, FIREBASE_URL, currentAuth) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL);

        vm.currentUser = undefined;

        function activate() {
            if (currentAuth && currentAuth.uid) {
                $firebaseObject(fbRef.child('users').child(currentAuth.uid)).$loaded().then(function (user) {
                    vm.currentUser = {
                        uid: user.uid,
                        username: user.username
                    };
                });
            } else {
                $location.path('/login').search('redirect', 'deckbuilder');
            }
        }

        $firebaseAuth(fbRef).$onAuth(function (auth) {
            if (!auth) {
                $location.path('/login').search('redirect', 'deckbuilder');
            }
        });

        activate();
    }
    deckbuilder.$inject = ['$location', '$firebaseObject', '$firebaseAuth', 'FIREBASE_URL', 'currentAuth'];

    angular.module('arcana').controller('deckbuilder', deckbuilder);
}());
(function () {
    'use strict';

    function decks($location, $firebaseObject, $firebaseAuth, FIREBASE_URL, currentAuth) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL);

        vm.currentUser = undefined;

        function activate() {
            if (currentAuth && currentAuth.uid) {
                $firebaseObject(fbRef.child('users').child(currentAuth.uid)).$loaded().then(function (user) {
                    vm.currentUser = {
                        uid: user.uid,
                        username: user.username
                    };
                });
            } else {
                $location.path('/login').search('redirect', 'decks');
            }
        }

        $firebaseAuth(fbRef).$onAuth(function (auth) {
            if (!auth) {
                $location.path('/login').search('redirect', 'decks');
            }
        });

        activate();
    }
    decks.$inject = ['$location', '$firebaseObject', '$firebaseAuth', 'FIREBASE_URL', 'currentAuth'];

    angular.module('arcana').controller('decks', decks);
}());
(function () {
    'use strict';

    function home($firebaseObject, $firebaseAuth, FIREBASE_URL) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL),
            fbAuth = $firebaseAuth(fbRef);

        vm.currentUser = fbAuth.$getAuth();

        function activate() {
            if (vm.currentUser && vm.currentUser.uid) {
                $firebaseObject(fbRef.child('users').child(vm.currentUser.uid)).$loaded().then(function (user) {
                    vm.currentUser.username = user.username;
                });
            }
        }

        fbAuth.$onAuth(function (authData) {
            vm.currentUser = authData;
            if (authData) {
                $firebaseObject(fbRef.child('users').child(vm.currentUser.uid)).$loaded().then(function (user) {
                    vm.currentUser.username = user.username;
                });
            }
        });

        activate();
    }
    home.$inject = ['$firebaseObject', '$firebaseAuth', 'FIREBASE_URL'];

    angular.module('arcana').controller('home', home);
}());
(function () {
    'use strict';

    function header($firebaseAuth, $firebaseObject, FIREBASE_URL, authService) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL);

        vm.currentUser = undefined;

        $firebaseAuth(fbRef).$onAuth(function (authData) {
            if (authData) {
                $firebaseObject(fbRef.child('users').child(authData.uid)).$loaded().then(function (user) {
                    vm.currentUser = { username: user.username };
                });
            }
        });

        vm.logout = function () {
            authService.logout();
            vm.currentUser = undefined;
        };
    }
    header.$inject = ['$firebaseAuth', '$firebaseObject', 'FIREBASE_URL', 'authService'];

    angular.module('arcana').controller('header', header);
}());
(function () {
    'use strict';

    function authService($firebaseAuth, $firebaseObject) {
        var fbRef = new Firebase('https://glaring-heat-7532.firebaseio.com/'),
            fbAuth = $firebaseAuth(fbRef);

        function login(model) {
            return fbAuth.$authWithPassword(model);
        }

        function logout() {
            fbAuth.$unauth();
        }

        function register(userInfo) {
            return ASQ(userInfo).then(function (next, userInfo) {
                fbAuth.$createUser(userInfo).then(function (userData) {
                    userInfo.uid = userData.uid;
                    next(userInfo);
                }).catch(function (error) {
                    next.fail(error);
                });
            }).then(function (next, userInfo) {
                var userRef = $firebaseObject(fbRef.child('users').child(userInfo.uid));
                userRef.username = userInfo.username;
                userRef.email = userInfo.email;
                userRef.$save().then(function () {
                    next(userInfo);
                });
            }).then(function (next, userInfo) {
                fbAuth.$authWithPassword(userInfo);
                next();
            });
        }

        function waitForAuth() {
            return fbAuth.$waitForAuth();
        }

        function requireAuth() {
            return fbAuth.$requireAuth();
        }

        function getAuth() {
            return fbAuth.$getAuth();
        }

        return {
            login: login,
            logout: logout,
            register: register,
            waitForAuth: waitForAuth,
            requireAuth: requireAuth,
            getAuth: getAuth
        };
    }
    authService.$inject = ['$firebaseAuth', '$firebaseObject'];

    angular.module('arcana').factory('authService', authService);
}());
(function () {
    'use strict';

    function highlightActive() {
        /*jslint unparam: true*/
        function controller($scope, $element, $attrs, $location) {
            var links = $element.find('a'),
                path = function () {
                    return $location.path();
                },
                highlight = function (links, path) {
                    path = '#' + path;
                    return angular.forEach(links, function (link) {
                        var $link = angular.element(link),
                            $li = $link.parent('li'),
                            href = $link.attr('href');

                        if ($li.hasClass('active')) {
                            $li.removeClass('active');
                        }

                        if (path === href) {
                            return $li.addClass('active');
                        }
                    });
                };

            highlight(links, $location.path());
            return $scope.$watch(path, function (newVal, oldVal) {
                if (newVal === oldVal) {
                    return;
                }

                return highlight(links, $location.path());
            });
        }
        /*jslint unparam: false*/
        controller.$inject = ['$scope', '$element', '$attrs', '$location'];

        return {
            restrict: 'A',
            controller: controller
        };
    }

    function customPage() {
        function controller($scope, $element, $location) {
            var path = function () {
                    return $location.path();
                },
                addBg = function (path) {
                    $element.removeClass('body-wide body-err body-lock body-auth');
                    switch (path) {
                        case '/login':
                        case '/register':
                            return $element.addClass('body-wide body-auth');
                        default:
                            break;
                    }
                };

            addBg($location.path());
            return $scope.$watch(path, function (newVal, oldVal) {
                if (newVal === oldVal) {
                    return;
                }

                return addBg($location.path());
            });
        }
        controller.$inject = ['$scope', '$element', '$location'];

        return {
            restrict: 'A',
            controller: controller
        };
    }

    angular.module('arcana')
        .directive('highlightActive', highlightActive)
        .directive('customPage', customPage);
}());
(function () {
    'use strict';

    function store($location, $firebaseObject, $firebaseAuth, FIREBASE_URL, currentAuth) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL);

        vm.currentUser = undefined;

        function activate() {
            if (currentAuth && currentAuth.uid) {
                $firebaseObject(fbRef.child('users').child(currentAuth.uid)).$loaded().then(function (user) {
                    vm.currentUser = {
                        uid: user.uid,
                        username: user.username
                    };
                });
            } else {
                $location.path('/login').search('redirect', 'store');
            }
        }

        $firebaseAuth(fbRef).$onAuth(function (auth) {
            if (!auth) {
                $location.path('/login').search('redirect', 'store');
            }
        });

        activate();
    }
    store.$inject = ['$location', '$firebaseObject', '$firebaseAuth', 'FIREBASE_URL', 'currentAuth'];

    angular.module('arcana').controller('store', store);
}());
(function () {
    'use strict';

    function adminAddCard($modalInstance, $firebaseArray, FIREBASE_URL, cardType) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL + '/cards');

        vm.card = {
            cardName: '',
            cardType: cardType,
            creatureType: 'Organic',
            rarity: 'Normal',
            instanceCost: 0,
            maintenanceCost: 0,
            genValue: 0,
            burnValue: 0,
            health: 0,
            power: 0,
            description: '',
            flavorText: ''
        };

        vm.cardTypes = ['Creature', 'Battery', 'Modifier', 'Sorcery'];
        vm.creatureTypes = ['Organic', 'Mystical'];
        vm.rarities = ['Normal', 'Uncommon', 'Rare', 'Epic', 'Legendary'];

        vm.submit = function () {
            var cardRef = fbRef.child(vm.card.cardType.toLowerCase()),
                card = _.pick(vm.card, ['cardName', 'rarity', 'instanceCost', 'maintenanceCost', 'genValue', 'burnValue', 'health', 'power', 'description', 'flavorText']);

            // TODO: This needs to get refactored somehow
            if (vm.card.cardType === 'Creature') {
                card.creatureType = vm.card.creatureType;
            }

            $firebaseArray(cardRef).$add(card).then(function () {
                $modalInstance.close();
            });
        };

        vm.cancel = function () {
            $modalInstance.close();
        };
    }
    adminAddCard.$inject = ['$modalInstance', '$firebaseArray', 'FIREBASE_URL', 'cardType'];

    angular.module('arcana').controller('adminAddCard', adminAddCard);
}());
(function () {
    'use strict';

    function adminCards($modal, $firebaseArray, $firebaseObject, FIREBASE_URL) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL + '/cards');

        vm.cardType = 'Battery';

        vm.loadCards = function () {
            $firebaseArray(fbRef.child(vm.cardType.toLowerCase())).$loaded(function (data) {
                vm.cards = data;
            });
        };

        vm.showCards = function (cardType) {
            vm.cardType = cardType;
            vm.loadCards();
        };

        vm.addCard = function () {
            $modal.open({
                templateUrl: '/app/admin/cards/adminAddCard.html',
                controller: 'adminAddCard',
                controllerAs: 'vm',
                resolve: {
                    cardType: function () {
                        return vm.cardType;
                    }
                }
            });
        };

        vm.editCard = function (cardId) {
            $firebaseObject(fbRef.child(vm.cardType.toLowerCase()).child(cardId)).$loaded(function (data) {
                $modal.open({
                    templateUrl: '/app/admin/cards/adminEditCard.html',
                    controller: 'adminEditCard',
                    controllerAs: 'vm',
                    resolve: {
                        cardInfo: function () {
                            return {
                                card: data,
                                cardType: vm.cardType
                            };
                        }
                    }
                });
            });
        };

        vm.deleteCard = function (cardId) {
            $firebaseObject(fbRef.child(vm.cardType).child(cardId)).$remove();
        };

        function activate() {
            vm.loadCards();
        }

        activate();
    }
    adminCards.$inject = ['$modal', '$firebaseArray', '$firebaseObject', 'FIREBASE_URL'];

    angular.module('arcana').controller('adminCards', adminCards);
}());
(function () {
    'use strict';

    function adminEditCard($modalInstance, cardInfo) {
        var vm = this;

        vm.card = cardInfo.card;
        vm.cardType = cardInfo.cardType;
        vm.title = 'Update Card - ' + vm.card.cardName;
        vm.creatureTypes = ['Organic', 'Mystical'];
        vm.rarities = ['Normal', 'Uncommon', 'Rare', 'Epic', 'Legendary'];

        vm.submit = function () {
            vm.card.$save().then(function () {
                $modalInstance.close();
            });
        };

        vm.cancel = function () {
            $modalInstance.close();
        };
    }
    adminEditCard.$inject = ['$modalInstance', 'cardInfo'];

    angular.module('arcana').controller('adminEditCard', adminEditCard);
}());
(function () {
    'use strict';

    function adminAddDeck($location, $firebaseArray, FIREBASE_URL) {
        var vm = this,
            cardsFbRef = new Firebase(FIREBASE_URL + '/cards'),
            decksFbRef = new Firebase(FIREBASE_URL + '/decks'),
            cardPropsToSave = ['$id', 'cardName', 'cardType', 'label', 'genValue', 'instanceCost', 'maintenanceCost', 'burnValue', 'health', 'power', 'rarity', 'description', 'flavorText', 'creatureType'];

        vm.batteryCards = [];
        vm.selectedBatteryCards = [];
        vm.creatureCards = [];
        vm.selectedCreatureCards = [];
        vm.sorceryCards = [];
        vm.selectedSorceryCards = [];
        vm.modifierCards = [];
        vm.selectedModifierCards = [];

        vm.deckCards = [];

        function getCardByCardType(cardType) {
            var cardId;
            switch (cardType) {
                case 'Battery':
                    cardId = vm.selectedBatteryCards[0];
                    return _.findWhere(vm.batteryCards, { $id: cardId });
                case 'Creature':
                    cardId = vm.selectedCreatureCards[0];
                    return _.findWhere(vm.creatureCards, { $id: cardId });
                case 'Sorcery':
                    cardId = vm.selectedSorceryCards[0];
                    return _.findWhere(vm.sorceryCards, { $id: cardId });
                case 'Modifier':
                    cardId = vm.selectedModifierCards[0];
                    return _.findWhere(vm.modifierCards, { $id: cardId });
                default:
                    return undefined;
            }
        }

        vm.addCard = function (cardType) {
            var selectedCard = getCardByCardType(cardType),
                card;
            if (selectedCard) {
                card = _.pick(selectedCard, cardPropsToSave);
                vm.deckCards.push(card);
            }
        };

        vm.removeCard = function (cardId) {
            var existingCard = _.findWhere(vm.deckCards, { $id: cardId });
            if (existingCard) {
                vm.deckCards = _.reject(vm.deckCards, function (card) {
                    return card.$id === cardId;
                });
            }
        };

        vm.submit = function () {
            var deck = {
                deckName: vm.deckName,
                cardCount: vm.deckCards.length,
                cards: vm.deckCards,
                batteryCardsCount: _.where(vm.deckCards, { cardType: 'Battery' }).length,
                creatureCardsCount: _.where(vm.deckCards, { cardType: 'Creature' }).length,
                sorceryCardCount: _.where(vm.deckCards, { cardType: 'Sorcery' }).length,
                modifierCardCount: _.where(vm.deckCards, { cardType: 'Modifier' }).length
            };

            $firebaseArray(decksFbRef).$add(deck).then(function () {
                $location.path('/admin/decks');
            });
        };

        vm.cancel = function () {
            $location.path('/admin/decks');
        };

        function loadCards() {
            $firebaseArray(cardsFbRef.child('battery')).$loaded(function (data) {
                angular.forEach(data, function (card) {
                    card.label = card.cardName + ' (G: ' + card.genValue + ')';
                    card.cardType = 'Battery';
                    vm.batteryCards.push(card);
                });
            });

            $firebaseArray(cardsFbRef.child('creature')).$loaded(function (data) {
                angular.forEach(data, function (card) {
                    card.label = card.cardName + ' (I: ' + card.instanceCost + ' | M: ' + card.maintenanceCost + ' | H: ' + card.health + ' | P: ' + card.power + ')';
                    card.cardType = 'Creature';
                    vm.creatureCards.push(card);
                });
            });

            $firebaseArray(cardsFbRef.child('sorcery')).$loaded(function (data) {
                angular.forEach(data, function (card) {
                    card.label = card.cardName + ' (I: ' + card.instanceCost + ' | M: ' + card.maintenanceCost + ')';
                    card.cardType = 'Sorcery';
                    vm.sorceryCards.push(card);
                });
            });

            $firebaseArray(cardsFbRef.child('modifier')).$loaded(function (data) {
                angular.forEach(data, function (card) {
                    card.label = card.cardName + ' (I: ' + card.instanceCost + ' | M: ' + card.maintenanceCost + ')';
                    card.cardType = 'Modifier';
                    vm.modifierCards.push(card);
                });
            });
        }

        function activate() {
            loadCards();
        }

        activate();
    }
    adminAddDeck.$inject = ['$location', '$firebaseArray', 'FIREBASE_URL'];

    angular.module('arcana').controller('adminAddDeck', adminAddDeck);
}());
(function () {
    'use strict';

    function adminDecks($firebaseArray, $firebaseObject, FIREBASE_URL) {
        var vm = this,
            fbRef = new Firebase(FIREBASE_URL + '/decks');

        $firebaseArray(fbRef).$loaded(function (data) {
            vm.decks = data;
        });

        vm.deleteDeck = function (deckId) {
            $firebaseObject(fbRef.child(deckId)).$remove();
        };
    }
    adminDecks.$inject = ['$firebaseArray', '$firebaseObject', 'FIREBASE_URL'];

    angular.module('arcana').controller('adminDecks', adminDecks);
}());
(function () {
    'use strict';

    function adminEditDeck($firebaseObject, deckId) {
        var vm = this;
        vm.deckId = deckId;
    }
    adminEditDeck.$inject = ['$firebaseObject', 'deckId'];

    angular.module('arcana').controller('adminEditDeck', adminEditDeck);
}());